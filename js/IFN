const cheerio = createCheerio()

const UA = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36'

let appConfig = {
    ver: 1,
    title: 'IFN',
    site: 'https://cn.ifn.watch',
}

async function getConfig() {
    let config = appConfig
    config.tabs = await getTabs()
    return jsonify(config)
}

async function getTabs() {
    let list = [
        {
            name: '电影',
            ext: {
                url: appConfig.site + '/category/3',
            },
        },
        {
            name: '剧集',
            ext: {
                url: appConfig.site + '/category/4',
            },
        },
        {
            name: '综艺',
            ext: {
                url: appConfig.site + '/category/5',
            },
        },
        {
            name: '动漫',
            ext: {
                url: appConfig.site + '/category/6',
            },
        },
        {
            name: '纪录片',
            ext: {
                url: appConfig.site + '/category/7',
            },
        },
        {
            name: '4K',
            ext: {
                url: appConfig.site + '/category/40',
            },
        },
    ]
    return list
}

async function getCards(ext) {
    ext = argsify(ext)
    let cards = []
    let { page = 1, url } = ext

    if (page > 1 && url) {
        // IFN 的分页可能是 ?page= 或其他格式，需要实际测试
        url = url + `?page=${page}`
    }

    try {
        const { data } = await $fetch.get(url, {
            headers: {
                'User-Agent': UA,
            },
        })

        const $ = cheerio.load(data)

        // 方法1：解析标准卡片结构
        $('a[href^="/detail/"]').each((_, element) => {
            const linkElem = $(element)
            const href = linkElem.attr('href')
            
            // 获取标题 - 尝试多种方式
            let title = ''
            const h3Elem = linkElem.find('h3')
            if (h3Elem.length > 0) {
                title = h3Elem.text().trim()
            }
            
            // 如果找不到标题，尝试从 img alt 获取
            if (!title) {
                const img = linkElem.find('img')
                title = img.attr('alt') || img.attr('title') || ''
            }
            
            // 获取封面图片
            let cover = ''
            const img = linkElem.find('img')
            if (img.length > 0) {
                cover = img.attr('data-src') || img.attr('src') || ''
                // 补全域名
                if (cover && cover.startsWith('/')) {
                    cover = appConfig.site + cover
                }
            }
            
            // 获取评分
            let rating = ''
            // 尝试从包含数字+分的文本中提取
            const text = linkElem.text()
            const ratingMatch = text.match(/(\d+\.?\d*)分/)
            if (ratingMatch) {
                rating = ratingMatch[1] + '分'
            }

            if (href && title) {
                const fullUrl = href.startsWith('http') ? href : appConfig.site + href
                cards.push({
                    vod_id: href,
                    vod_name: title,
                    vod_pic: cover,
                    vod_remarks: rating,
                    ext: {
                        url: fullUrl,
                    },
                })
            }
        })

        // 方法2：如果方法1没找到，尝试从 JSON 数据中提取
        if (cards.length === 0) {
            const jsonMatch = data.match(/window\.__INITIAL_STATE__\s*=\s*(\{[^;]+\});/)
            if (jsonMatch) {
                try {
                    const initialState = JSON.parse(jsonMatch[1])
                    if (initialState.list && initialState.list.length > 0) {
                        initialState.list.forEach(item => {
                            cards.push({
                                vod_id: item.id || item.mediaId,
                                vod_name: item.title || item.name,
                                vod_pic: item.coverImgUrl || item.cover,
                                vod_remarks: item.score || item.updateStatus,
                                ext: {
                                    url: appConfig.site + '/detail/' + (item.mediaId || item.id),
                                },
                            })
                        })
                    }
                } catch (e) {
                    $print('解析 INITIAL_STATE 失败: ' + e)
                }
            }
        }

        // 去重处理
        const seen = new Set()
        cards = cards.filter(card => {
            if (seen.has(card.vod_id)) {
                return false
            }
            seen.add(card.vod_id)
            return true
        })

    } catch (error) {
        $print('Error in getCards: ' + error)
    }

    return jsonify({
        list: cards,
    })
}

async function getTracks(ext) {
    ext = argsify(ext)
    let tracks = []
    let url = ext.url

    try {
        const { data } = await $fetch.get(url, {
            headers: {
                'User-Agent': UA,
            },
        })

        const $ = cheerio.load(data)
        const playGroups = []
        
        // 方法1：从 detailData JSON 中提取剧集信息
        const detailDataMatch = data.match(/"detailData":(\{[^}]+\})/)
        if (detailDataMatch) {
            try {
                const detailData = JSON.parse(detailDataMatch[1])
                if (detailData.episodes && detailData.episodes.length > 0) {
                    const episodes = []
                    detailData.episodes.forEach((ep, index) => {
                        episodes.push({
                            name: ep.title || `第${index + 1}集`,
                            pan: '',
                            ext: {
                                url: url, // 使用详情页URL，播放时在getPlayinfo中提取
                                episodeId: ep.id || ep.episodeId,
                                episodeIndex: index,
                            },
                        })
                    })
                    
                    if (episodes.length > 0) {
                        playGroups.push({
                            title: '默认线路',
                            tracks: episodes
                        })
                    }
                }
            } catch (e) {
                $print('解析 detailData 失败: ' + e)
            }
        }
        
        // 方法2：从 JSON-LD 中提取剧集信息
        if (playGroups.length === 0) {
            const jsonLdMatch = data.match(/<script type="application\/ld\+json">([\s\S]*?)<\/script>/)
            if (jsonLdMatch) {
                try {
                    const jsonLd = JSON.parse(jsonLdMatch[1])
                    if (jsonLd.episode && jsonLd.episode.length > 0) {
                        const episodes = []
                        jsonLd.episode.forEach((ep, index) => {
                            episodes.push({
                                name: ep.name || `第${ep.episodeNumber || index + 1}集`,
                                pan: '',
                                ext: {
                                    url: url,
                                    episodeIndex: index,
                                },
                            })
                        })
                        
                        if (episodes.length > 0) {
                            playGroups.push({
                                title: '默认线路',
                                tracks: episodes
                            })
                        }
                    }
                } catch (e) {
                    $print('解析 JSON-LD 失败: ' + e)
                }
            }
        }
        
        // 方法3：从页面按钮中提取剧集
        if (playGroups.length === 0) {
            const episodes = []
            let index = 0
            
            // 查找所有包含集数文本的按钮
            $('button').each((_, element) => {
                const btn = $(element)
                const title = btn.attr('title')
                const text = btn.text().trim()
                
                // 匹配集数格式：01, 02, 第1集, 第01集 等
                if (title && /^\d+$|^第\d+集$/.test(title)) {
                    episodes.push({
                        name: title,
                        pan: '',
                        ext: {
                            url: url,
                            episodeIndex: index++,
                        },
                    })
                }
            })
            
            if (episodes.length > 0) {
                playGroups.push({
                    title: '默认线路',
                    tracks: episodes
                })
            }
        }
        
        tracks = playGroups
        
    } catch (error) {
        $print('Error in getTracks: ' + error)
    }

    return jsonify({
        list: tracks,
    })
}

async function getPlayinfo(ext) {
    ext = argsify(ext)
    const url = ext.url
    const episodeId = ext.episodeId || ''
    const episodeIndex = ext.episodeIndex || 0
    let playurl = ''
    
    // IFN 登录凭证 - Bearer Token
    const AUTH_TOKEN = 'Bearer eyJhbGciOiJIUzI1NiIsImtpZCI6Im80NmhCZ3hiSEgyQjZsenQiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL3J2Y3Jyd2R0Z2d2Ym9tdnp2cGV2LnN1cGFiYXNlLmNvL2F1dGgvdjEiLCJzdWIiOiI2NTA0MThiZS1iZTc3LTRjYTItOWY3YS0xNWU3Y2YxNzRlNGUiLCJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzcwMTA2NTMzLCJpYXQiOjE3NzAxMDI5MzMsImVtYWlsIjoidC5heS5haC5zLmNody5hcnoyNS43QGdtYWlsLmNvbSIsInBob25lIjoiIiwiYXBwX21ldGFkYXRhIjp7InByb3ZpZGVyIjoiZW1haWwiLCJwcm92aWRlcnMiOlsiZW1haWwiXX0sInVzZXJfbWV0YWRhdGEiOnsiZW1haWwiOiJ0LmF5LmFoLnMuY2h3LmFyejI1LjdAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBob25lX3ZlcmlmaWVkIjpmYWxzZSwic3ViIjoiNjUwNDE4YmUtYmU3Ny00Y2EyLTlmN2EtMTVlN2NmMTc0ZTRlIiwidWFfZGF0YTp7ImNmSW5mbyI6eyJhc09yZ2FuaXphdGlvbiI6IktpcmlubyBMTEMiLCJjaXR5IjoiSG9uZyBLb25nIiwiY29sbCI6IkhLRyIsImNvdW50cnkiOiJISyIsInJlZ2lvbiI6IlhYIiwicmVnaW9uQ29kZSI6IlhYIn0sImlzZnJvbSI6InVua25vd24iLCJyZWFsSXAiOiIyMTIuMTA3LjI5LjE5OCIsInJlZmVyIjoiZGlyZWN0IiwicmVmZXJlciI6ImRpcmVjdCIsInVybCI6InVua25vd24iLCJ1c2VyQWdlbnQiOiJNb3ppbGxhLzUuMCAoV2luZG93cyBOVCAxMC4wOyBXaW42NDsgeDY0KSBBcHBsZVdlYktpdC81MzcuMzYgKEtIVE1MLCBsaWtlIEdlY2tvKSBDaHJvbWUvMTM2LjAuMC4wIFNhZmFyaS81MzcuMzYifSwidXNlcm5hbWUiOiJza3RpIn0sInJvbGUiOiJhdXRoZW50aWNhdGVkIiwiYWFsIjoiYWFsMSIsImFtciI6W3sibWV0aG9kIjoib3RwIiwidGltZXN0YW1wIjoxNzcwMTAyOTMzfV0sInNlc3Npb25faWQiOiIxMzIyMDI4Zi0wYzQwLTQ3MzktODczNy04YzJlOGQyNGZjYjgiLCJpc19hbm9ueW1vdXMiOmZhbHNlfQ.eV94hY2VBkE0l2xPiMe_DdW6xBKBhblRXePx2YCqa8Q'

    try {
        // 首先获取详情页，提取必要的播放信息（带认证）
        const { data } = await $fetch.get(url, {
            headers: {
                'User-Agent': UA,
                'Authorization': AUTH_TOKEN,
            },

        // 方法1：从 detailData 中提取剧集的 playUrl 或 url
        const detailDataMatch = data.match(/"detailData":(\{[^}]+\})/)
        if (detailDataMatch) {
            try {
                const detailData = JSON.parse(detailDataMatch[1])
                if (detailData.episodes && detailData.episodes[episodeIndex]) {
                    const episode = detailData.episodes[episodeIndex]
                    // IFN 使用 HLS 流媒体，playUrl 可能是 m3u8 或加密链接
                    if (episode.playUrl || episode.url || episode.videoUrl) {
                        playurl = episode.playUrl || episode.url || episode.videoUrl
                        $print('✓ 从 detailData.episodes 提取: ' + playurl)
                    }
                }
            } catch (e) {
                $print('解析 detailData 失败: ' + e)
            }
        }
        
        // 方法2：查找 /api/ts?url= 格式的播放链接
        if (!playurl) {
            const tsApiMatch = data.match(/["'](\/api\/ts\?url=[^"']+)["']/)
            if (tsApiMatch) {
                playurl = appConfig.site + tsApiMatch[1]
                $print('✓ 从 /api/ts 提取: ' + playurl)
            }
        }
        
        // 方法3：查找 m3u8 播放列表链接
        if (!playurl) {
            const m3u8Match = data.match(/(https?:\/\/[^\s"'<>]+\.m3u8[^\s"'<>]*)/)
            if (m3u8Match) {
                playurl = m3u8Match[1]
                $print('✓ 从 m3u8 提取: ' + playurl)
            }
        }
        
        // 方法4：查找 .ts 切片链接（可能是 HLS 的一部分）
        if (!playurl) {
            const tsMatch = data.match(/(https?:\/\/[^\s"'<>]+\.ts[^\s"'<>]*)/)
            if (tsMatch) {
                playurl = tsMatch[1]
                $print('✓ 从 .ts 切片提取: ' + playurl)
            }
        }
        
        // 方法5：查找 iframe 视频源
        if (!playurl) {
            const iframeMatch = data.match(/<iframe[^>]+src=["']([^"']+)["']/))
                if (iframeMatch) {
                    playurl = iframeMatch[1]
                    if (!playurl.startsWith('http')) {
                        playurl = appConfig.site + playurl
                    }
                    $print('✓ 从 iframe 提取: ' + playurl)
                }
            }
            
            // 方法5：查找其他视频链接模式
            if (!playurl) {
                const videoMatch = data.match(/["'](https?:\/\/[^"']*(?:video|play|stream)[^"']*)["']/)
                if (videoMatch) {
                    playurl = videoMatch[1]
                    $print('✓ 从视频链接提取: ' + playurl)
                }
            }
            
            // 方法6：从 detailData 中提取播放地址
            if (!playurl) {
                const detailDataMatch = data.match(/"detailData":(\{[^}]+\})/)
                if (detailDataMatch) {
                    try {
                        const detailData = JSON.parse(detailDataMatch[1])
                        // 如果有 episodes 数组，尝试获取对应集数的播放地址
                        if (detailData.episodes && detailData.episodes[episodeIndex]) {
                            const episode = detailData.episodes[episodeIndex]
                            if (episode.url || episode.playUrl || episode.videoUrl) {
                                playurl = episode.url || episode.playUrl || episode.videoUrl
                                $print('✓ 从 detailData.episodes 提取: ' + playurl)
                            }
                        }
                    } catch (e) {
                        $print('解析 detailData 失败: ' + e)
                    }
                }
            }
            
            // 方法6：查找通用的视频链接
            if (!playurl) {
                const videoMatch = data.match(/["'](https?:\/\/[^"']*(?:video|play|stream)[^"']*)["']/)
                if (videoMatch) {
                    playurl = videoMatch[1]
                    $print('✓ 从视频链接提取: ' + playurl)
                }
            }
            
            // 方法7：查找任何包含媒体扩展名的 src
            if (!playurl) {
                const srcMatch = data.match(/src=["'](https?:\/\/[^"']+\.(?:m3u8|mp4|flv|ts)[^"']*)["']/)
                if (srcMatch) {
                    playurl = srcMatch[1]
                    $print('✓ 从 src 属性提取: ' + playurl)
                }
            }
        }
        
        // 如果获取的是相对路径的 /api/ts?url=，确保补全域名
        if (playurl && playurl.startsWith('/api/')) {
            playurl = appConfig.site + playurl
            $print('✓ 补全 API 域名: ' + playurl)
        }
        
        if (!playurl) {
            $print('✗ 未能提取视频URL，请检查网站是否需要登录或特殊处理')
        }
        
    } catch (error) {
        $print('获取播放信息失败: ' + error)
    }

    return jsonify({
        urls: [playurl],
        headers: [
            {
                'User-Agent': UA,
                Referer: appConfig.site,
                'Authorization': AUTH_TOKEN,
            },
        ],
    })
}

async function search(ext) {
    ext = argsify(ext)
    let cards = []
    let text = encodeURIComponent(ext.text)
    let page = ext.page || 1
    let url = `${appConfig.site}/search?keyword=${text}`

    if (page > 1) {
        url += `&page=${page}`
    }

    try {
        const { data } = await $fetch.get(url, {
            headers: {
                'User-Agent': UA,
            },
        })

        const $ = cheerio.load(data)

        // 使用与 getCards 相同的解析逻辑
        $('a[href^="/detail/"]').each((_, element) => {
            const linkElem = $(element)
            const href = linkElem.attr('href')
            
            let title = linkElem.find('h3, .title, [class*="title"]').text().trim()
            if (!title) {
                const img = linkElem.find('img')
                title = img.attr('alt') || ''
            }
            
            let cover = ''
            const img = linkElem.find('img')
            if (img.length > 0) {
                cover = img.attr('data-src') || img.attr('src') || ''
                if (cover && cover.startsWith('/api/image/')) {
                    cover = appConfig.site + cover
                }
            }
            
            const ratingElem = linkElem.find('.rating, [class*="score"], [class*="rating"]')
            let rating = ratingElem.text().trim()
            
            if (!rating) {
                const text = linkElem.text()
                const ratingMatch = text.match(/(\d+\.?\d*)分/)
                if (ratingMatch) {
                    rating = ratingMatch[1] + '分'
                }
            }

            if (href && title) {
                const fullUrl = href.startsWith('http') ? href : appConfig.site + href
                cards.push({
                    vod_id: href,
                    vod_name: title,
                    vod_pic: cover,
                    vod_remarks: rating,
                    ext: {
                        url: fullUrl,
                    },
                })
            }
        })

        // 去重
        const seen = new Set()
        cards = cards.filter(card => {
            if (seen.has(card.vod_id)) {
                return false
            }
            seen.add(card.vod_id)
            return true
        })

    } catch (error) {
        $print('Error in search: ' + error)
    }

    return jsonify({
        list: cards,
    })
}
